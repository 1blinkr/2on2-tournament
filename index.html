<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2on2 Tournament - One Piece TCG</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pirata+One&family=Crimson+Pro:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --navy: #0a0e1a; --deep: #0d1426; --card: #111827; --border: #1e2d4a; --gold: #c9a84c; --gold-light: #f0c96e; --red: #c0392b; --red-light: #e74c3c; --teal: #1abc9c; --teal-dark: #16a085; --text: #e8dcc8; --muted: #8a9bb5; --white: #f5f0e8; }
        body { background: var(--navy); color: var(--text); font-family: 'Crimson Pro', serif; min-height: 100vh; background-image: radial-gradient(ellipse at 20% 20%, rgba(201,168,76,0.04) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(26,188,156,0.04) 0%, transparent 50%); }
        .app { max-width: 480px; margin: 0 auto; padding: 0 0 80px 0; min-height: 100vh; }
        .header { background: linear-gradient(180deg, #0a0e1a 0%, #0d1426 100%); border-bottom: 2px solid var(--gold); padding: 20px 20px 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 24px rgba(201,168,76,0.15); }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .logo { font-family: 'Pirata One', cursive; font-size: 22px; color: var(--gold); letter-spacing: 1px; }
        .logo span { color: var(--teal); }
        .logout-btn { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); background: none; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; cursor: pointer; }
        .content { padding: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; position: relative; }
        .card-title { font-family: 'Pirata One', cursive; font-size: 18px; color: var(--gold); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .field { margin-bottom: 14px; }
        .label { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .input { width: 100%; background: var(--deep); border: 1px solid var(--border); border-radius: 8px; color: var(--white); font-family: 'Crimson Pro', serif; font-size: 16px; padding: 10px 14px; outline: none; }
        .btn { display: block; width: 100%; padding: 12px 20px; border-radius: 8px; border: none; font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: var(--navy); }
        .btn-teal { background: linear-gradient(135deg, var(--teal-dark), var(--teal)); color: var(--navy); }
        .btn-red { background: linear-gradient(135deg, var(--red), var(--red-light)); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--deep); border-radius: 10px; padding: 4px; }
        .tab { flex: 1; padding: 9px 8px; border: none; background: none; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 10px; cursor: pointer; border-radius: 7px; }
        .tab.active { background: var(--card); color: var(--gold); }
        .standing-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .standing-rank { font-family: 'Pirata One', cursive; font-size: 22px; color: var(--gold); opacity: 0.5; width: 32px; text-align: center; }
        .standing-name { flex: 1; font-size: 16px; font-weight: 700; color: var(--white); }
        .standing-pts { font-family: 'Pirata One', cursive; font-size: 20px; color: var(--gold); }
        .alert { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; text-align: center; }
        .alert-error { background: rgba(192,57,43,0.15); border: 1px solid rgba(192,57,43,0.4); color: var(--red-light); }
        .alert-success { background: rgba(26,188,156,0.15); border: 1px solid rgba(26,188,156,0.4); color: var(--teal); }
        .pairing-card { display: flex; flex-direction: column; gap: 10px; padding: 15px; background: var(--deep); border-radius: 10px; margin-bottom: 10px; }
        .pairing-team { display: flex; justify-content: space-between; align-items: center; }
        .pairing-vs { font-family: 'Pirata One', cursive; color: var(--gold); text-align: center; font-size: 14px; }
        .result-badges { display: flex; gap: 10px; margin-top: 10px; }
        .result-badge { flex: 1; padding: 8px; border-radius: 6px; text-align: center; font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; border: 1px solid var(--border); }
        .result-badge.win { background: rgba(26,188,156,0.1); color: var(--teal); border-color: var(--teal); }
        .result-badge.loss { background: rgba(192,57,43,0.1); color: var(--red-light); border-color: var(--red-light); }
        .login-screen { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
        .login-logo { font-family: 'Pirata One', cursive; font-size: 48px; color: var(--gold); text-align: center; }
        .login-sub { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--teal); letter-spacing: 4px; text-transform: uppercase; margin-bottom: 40px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const DB = {
            get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch(e) { return null; } },
            set: (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {} }
        };

        const INITIAL_STATE = {
            status: 'setup', 
            currentRound: 0,
            teams: [],
            rounds: [],
            adminPass: 'lojista123'
        };

        function App() {
            const [state, setState] = useState(() => DB.get('2on2_state') || INITIAL_STATE);
            const [session, setSession] = useState(null);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => { DB.set('2on2_state', state); }, [state]);

            const notify = (msg, isErr = false) => {
                if (isErr) { setError(msg); setSuccess(''); }
                else { setSuccess(msg); setError(''); }
                setTimeout(() => { setError(''); setSuccess(''); }, 4000);
            };

            const handleRegister = (data) => {
                if (!data.name || !data.pass) return notify('Preencha nome e senha.', true);
                if (state.teams.find(t => t.name.toLowerCase() === data.name.toLowerCase())) return notify('Dupla já existe.', true);
                
                const newTeam = { id: Date.now().toString(), name: data.name, p1: data.p1, p2: data.p2, pass: data.pass, confirmed: false, points: 0, opponents: [] };
                setState(prev => ({ ...prev, teams: [...prev.teams, newTeam] }));
                notify('Cadastro enviado! Peça ao admin para te aprovar.');
            };

            const handleLogin = (name, pass) => {
                const team = state.teams.find(t => t.name.toLowerCase() === name.toLowerCase() && t.pass === pass);
                if (!team) return notify('Nome ou senha incorretos.', true);
                if (!team.confirmed) return notify('Aguarde o admin aprovar sua dupla.', true);
                setSession({ type: 'team', id: team.id });
            };

            const handleAdminLogin = (pass) => {
                if (pass === state.adminPass) setSession({ type: 'admin' });
                else notify('Senha admin incorreta.', true);
            };

            const generateNextRound = () => {
                const confirmed = state.teams.filter(t => t.confirmed);
                if (confirmed.length < 2) return notify('Mínimo 2 duplas confirmadas.', true);
                
                const sorted = [...confirmed].sort((a, b) => b.points - a.points);
                const pairings = [];
                const paired = new Set();

                for (let i = 0; i < sorted.length; i++) {
                    if (paired.has(sorted[i].id)) continue;
                    let found = false;
                    for (let j = i + 1; j < sorted.length; j++) {
                        if (!paired.has(sorted[j].id) && !sorted[i].opponents.includes(sorted[j].id)) {
                            pairings.push({ t1: sorted[i].id, t2: sorted[j].id, result: null });
                            paired.add(sorted[i].id); paired.add(sorted[j].id);
                            found = true; break;
                        }
                    }
                    if (!found) {
                        const nextAvailable = sorted.slice(i+1).find(t => !paired.has(t.id));
                        if (nextAvailable) {
                            pairings.push({ t1: sorted[i].id, t2: nextAvailable.id, result: null });
                            paired.add(sorted[i].id); paired.add(nextAvailable.id);
                        } else {
                            pairings.push({ t1: sorted[i].id, t2: 'BYE', result: sorted[i].id });
                            paired.add(sorted[i].id);
                        }
                    }
                }

                setState(prev => ({ ...prev, status: 'active', currentRound: prev.currentRound + 1, rounds: [...prev.rounds, pairings] }));
                notify('Nova rodada gerada!');
            };

            const reportResult = (winnerId, loserId) => {
                const rIdx = state.currentRound - 1;
                const newRounds = [...state.rounds];
                const matchIdx = newRounds[rIdx].findIndex(m => (m.t1 === winnerId && m.t2 === loserId) || (m.t1 === loserId && m.t2 === winnerId));
                
                if (newRounds[rIdx][matchIdx].result) return notify('Resultado já existe.', true);
                newRounds[rIdx][matchIdx].result = winnerId;

                const newTeams = state.teams.map(t => {
                    if (t.id === winnerId) return { ...t, points: t.points + 3, opponents: [...t.opponents, loserId] };
                    if (t.id === loserId && loserId !== 'BYE') return { ...t, opponents: [...t.opponents, winnerId] };
                    return t;
                });

                setState(prev => ({ ...prev, rounds: newRounds, teams: newTeams }));
                notify('Resultado salvo!');
            };

            if (!session) return <Login onLogin={handleLogin} onRegister={handleRegister} onAdminLogin={handleAdminLogin} error={error} success={success} />;

            return (
                <div className="app">
                    <header className="header"><div className="header-top"><div className="logo">2on<span>2</span></div><button className="logout-btn" onClick={() => setSession(null)}>Sair</button></div></header>
                    <main className="content">
                        {error && <div className="alert alert-error">{error}</div>}
                        {success && <div className="alert alert-success">{success}</div>}
                        {session.type === 'admin' ? <AdminPanel state={state} setState={setState} onGenerate={generateNextRound} onReport={reportResult} /> : <PlayerPanel state={state} teamId={session.id} onReport={reportResult} />}
                    </main>
                </div>
            );
        }

        function Login({ onLogin, onRegister, onAdminLogin, error, success }) {
            const [mode, setMode] = useState('login');
            const [f, setF] = useState({ name:'', pass:'', p1:'', p2:'' });
            return (
                <div className="login-screen">
                    <div className="login-logo">2on<span>2</span></div><div className="login-sub">One Piece TCG</div>
                    <div className="card" style={{width:'100%'}}>
                        <div className="tabs">
                            <button className={`tab ${mode==='login'?'active':''}`} onClick={()=>setMode('login')}>Entrar</button>
                            <button className={`tab ${mode==='reg'?'active':''}`} onClick={()=>setMode('reg')}>Cadastrar</button>
                            <button className={`tab ${mode==='admin'?'active':''}`} onClick={()=>setMode('admin')}>Admin</button>
                        </div>
                        {mode==='login' && (<div><div className="field"><label className="label">Dupla</label><input className="input" onChange={e=>setF({...f, name:e.target.value})}/></div><div className="field"><label className="label">Senha</label><input className="input" type="password" onChange={e=>setF({...f, pass:e.target.value})}/></div><button className="btn btn-gold" onClick={()=>onLogin(f.name, f.pass)}>Entrar</button></div>)}
                        {mode==='reg' && (<div><div className="field"><label className="label">Nome da Dupla</label><input className="input" onChange={e=>setF({...f, name:e.target.value})}/></div><div className="field"><label className="label">Jogador 1</label><input className="input" onChange={e=>setF({...f, p1:e.target.value})}/></div><div className="field"><label className="label">Jogador 2</label><input className="input" onChange={e=>setF({...f, p2:e.target.value})}/></div><div className="field"><label className="label">Senha</label><input className="input" type="password" onChange={e=>setF({...f, pass:e.target.value})}/></div><button className="btn btn-teal" onClick={()=>onRegister(f)}>Cadastrar</button></div>)}
                        {mode==='admin' && (<div><div className="field"><label className="label">Senha Admin</label><input className="input" type="password" onChange={e=>setF({...f, pass:e.target.value})}/></div><button className="btn btn-red" onClick={()=>onAdminLogin(f.pass)}>Admin</button></div>)}
                    </div>
                </div>
            );
        }

        function AdminPanel({ state, setState, onGenerate, onReport }) {
            const confirmed = state.teams.filter(t=>t.confirmed);
            const pending = state.teams.filter(t=>!t.confirmed);
            const currentR = state.rounds[state.currentRound-1] || [];
            
            return (
                <div>
                    <div className="card"><div className="card-title">Ações</div>
                        <button className="btn btn-gold" style={{marginBottom:'10px'}} onClick={onGenerate} disabled={state.status==='active' && currentR.some(m=>!m.result)}>
                            {state.status==='setup' ? 'Iniciar Torneio' : 'Próxima Rodada'}
                        </button>
                        <button className="btn btn-ghost" onClick={()=>{if(confirm('Resetar?'))setState(INITIAL_STATE)}}>Resetar Tudo</button>
                    </div>
                    {pending.length > 0 && (
                        <div className="card"><div className="card-title">Aprovar ({pending.length})</div>
                            {pending.map(t=>(<div key={t.id} className="standing-row"><div className="standing-name">{t.name}</div><button className="btn btn-teal" style={{width:'auto', padding:'4px 8px'}} onClick={()=>setState(p=>({...p, teams: p.teams.map(x=>x.id===t.id?({...x,confirmed:true}):x)}))}>OK</button></div>))}
                        </div>
                    )}
                    {state.status === 'active' && (
                        <div className="card"><div className="card-title">Rodada {state.currentRound}</div>
                            {currentR.map((m,i)=>(
                                <div key={i} className="pairing-card">
                                    <div className="pairing-team"><span>{state.teams.find(x=>x.id===m.t1)?.name}</span> <span>vs</span> <span>{m.t2==='BYE'?'BYE':state.teams.find(x=>x.id===m.t2)?.name}</span></div>
                                    {!m.result && m.t2!=='BYE' && (<div className="result-badges"><div className="result-badge win" onClick={()=>onReport(m.t1, m.t2)}>Ganhou T1</div><div className="result-badge win" onClick={()=>onReport(m.t2, m.t1)}>Ganhou T2</div></div>)}
                                    {m.result && <div className="alert alert-success" style={{margin:0}}>Vencedor: {state.teams.find(x=>x.id===m.result)?.name}</div>}
                                </div>
                            ))}
                        </div>
                    )}
                    <div className="card"><div className="card-title">Standings</div>
                        {[...confirmed].sort((a,b)=>b.points-a.points).map((t,i)=>(<div key={t.id} className="standing-row"><div className="standing-rank">{i+1}</div><div className="standing-name">{t.name}</div><div className="standing-pts">{t.points}</div></div>))}
                    </div>
                </div>
            );
        }

        function PlayerPanel({ state, teamId, onReport }) {
            const team = state.teams.find(t=>t.id===teamId);
            const match = state.rounds[state.currentRound-1]?.find(m=>m.t1===teamId || m.t2===teamId);
            const opp = match ? (match.t1===teamId ? match.t2 : match.t1) : null;
            const oppName = opp === 'BYE' ? 'BYE' : state.teams.find(x=>x.id===opp)?.name;

            return (
                <div>
                    <div className="card"><div className="card-title">{team.name}</div><div className="standing-pts" style={{textAlign:'center', fontSize:'40px'}}>{team.points} pts</div></div>
                    {match && (
                        <div className="card"><div className="card-title">Rodada {state.currentRound}</div>
                            <div className="pairing-card">
                                <div className="pairing-team"><span>{team.name}</span> <span className="pairing-vs">VS</span> <span>{oppName}</span></div>
                                {!match.result ? (<div className="result-badges"><div className="result-badge win" onClick={()=>onReport(teamId, opp)}>Ganhei</div><div className="result-badge loss" onClick={()=>onReport(opp, teamId)}>Perdi</div></div>) : (
                                    <div className={`alert ${match.result===teamId?'alert-success':'alert-error'}`} style={{marginTop:'10px'}}>{match.result===teamId?'VITORIA!':'DERROTA'}</div>
                                )}
                            </div>
                        </div>
                    )}
                    <div className="card"><div className="card-title">Classificação</div>
                        {[...state.teams].filter(t=>t.confirmed).sort((a,b)=>b.points-a.points).map((t,i)=>(
                            <div key={t.id} className="standing-row" style={{opacity:t.id===teamId?1:0.6}}>
                                <div className="standing-rank">{i+1}</div><div className="standing-name" style={{color:t.id===teamId?'var(--teal)':'white'}}>{t.name} {t.id===teamId&&'(Você)'}</div><div className="standing-pts">{t.points}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
